import os
import certifi
import sqlite3
import time
import threading
import asyncio
from pyrogram import Client, errors
import telebot
from telebot import types

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
api_id = 7911488845
api_hash = "f75fe6157dd68bdf0df5198adbc590fd"
TELEGRAM_TOKEN = "7966240362:AAGEz1SdchbTAg2vZcjTwip22_B7xGIEf64"
os.environ['SSL_CERT_FILE'] = certifi.where()

# Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
if not os.path.isfile("data.db"):
    with sqlite3.connect("data.db") as connection:
        cursor = connection.cursor()
        cursor.execute("CREATE TABLE IF NOT EXISTS accounts (ses TEXT, number TEXT, id TEXT)")
        connection.commit()

# Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def add_account(ses, number, user_id):
    with sqlite3.connect("data.db") as connection:
        cursor = connection.cursor()
        cursor.execute("INSERT INTO accounts VALUES (?, ?, ?)", (ses, number, user_id))
        connection.commit()

def get_accounts():
    with sqlite3.connect("data.db") as connection:
        cursor = connection.cursor()
        cursor.execute("SELECT * FROM accounts")
        return cursor.fetchall()

# Ø¯ÙˆØ§Ù„ Ù†Ù‚Ù„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
def get_users(from_group):
    users = []
    try:
        client = Client("session", api_id=api_id, api_hash=api_hash)
        client.start()
        for member in client.get_chat_members(from_group):
            users.append(member.user.id)
            time.sleep(1)
        client.stop()
    except Exception as e:
        print("Ø®Ø·Ø£ ÙÙŠ get_users:", e)
    return users

def add_users(users, to_group, chat_id, bot):
    try:
        client = Client("session", api_id=api_id, api_hash=api_hash)
        client.start()
        for user_id in users:
            try:
                client.add_chat_members(to_group, user_id)
                time.sleep(1)
            except Exception as e:
                print("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ:", e)
        client.stop()
        bot.send_message(chat_id, "âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­")
    except Exception as e:
        bot.send_message(chat_id, f"âŒ ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„: {e}")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(TELEGRAM_TOKEN, threaded=False, num_threads=55, skip_pending=True)

@bot.message_handler(commands=['start'])
def start(message):
    markup = types.InlineKeyboardMarkup()
    markup.add(
        types.InlineKeyboardButton("Ù†Ù‚Ù„ Ø§Ø¹Ø¶Ø§Ø¡ ğŸ‘¤", callback_data="transfer"),
        types.InlineKeyboardButton("Ø§Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ ğŸ›", callback_data="add"),
        types.InlineKeyboardButton("Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ğŸ–²", callback_data="show")
    )
    bot.send_message(message.chat.id, "Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ğŸ‘‹ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    if call.data == "show":
        accounts = get_accounts()
        bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id,
                              text=f"Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: {len(accounts)}")
    elif call.data == "add":
        msg = bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id,
                                    text="Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© ğŸ“")
        bot.register_next_step_handler(msg, handle_phone)
    elif call.data == "transfer":
        msg = bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id,
                                    text="Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ù…Ù†Ù‡ ğŸ–²")
        bot.register_next_step_handler(msg, get_from_group)

def handle_phone(message):
    phone = message.text
    bot.send_message(message.chat.id, "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯...")
    client = Client("::memory::", api_id=api_id, api_hash=api_hash, in_memory=True)
    client.connect()
    try:
        sent = client.send_code(phone)
        msg = bot.send_message(message.chat.id, "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙƒ ğŸ”")
        bot.register_next_step_handler(msg, handle_code, client, phone, sent.phone_code_hash)
    except Exception as e:
        bot.send_message(message.chat.id, f"Ø®Ø·Ø£: {e}")

def handle_code(message, client, phone, code_hash):
    try:
        client.sign_in(phone, code_hash, message.text)
        session = client.export_session_string()
        add_account(session, phone, message.chat.id)
        bot.send_message(message.chat.id, "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­")
    except errors.SessionPasswordNeeded:
        msg = bot.send_message(message.chat.id, "Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø³Ø§Ø¨Ùƒ ğŸ”")
        bot.register_next_step_handler(msg, handle_password, client, phone)

def handle_password(message, client, phone):
    try:
        client.check_password(message.text)
        session = client.export_session_string()
        add_account(session, phone, message.chat.id)
        bot.send_message(message.chat.id, "âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­")
    except Exception as e:
        bot.send_message(message.chat.id, f"Ø®Ø·Ø£: {e}")

def get_from_group(message):
    from_group = message.text
    msg = bot.send_message(message.chat.id, "Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„ÙŠÙ‡ ğŸ›")
    bot.register_next_step_handler(msg, get_to_group, from_group)

def get_to_group(message, from_group):
    to_group = message.text
    bot.send_message(message.chat.id, "Ø¬Ø§Ø±ÙŠ Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...")
    users = get_users(from_group)
    bot.send_message(message.chat.id, f"ØªÙ… Ø¬Ù…Ø¹ {len(users)} Ø¹Ø¶Ùˆ âœ… Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ù‚Ù„...")
    threading.Thread(target=asyncio.run, args=(add_users(users, to_group, message.chat.id, bot),)).start()

bot.infinity_polling()
